# Fluent Bit Configuration for AAA Accounting Service Monitoring
# This configuration tails the metrics JSON file and forwards to various outputs
# Enhanced with comprehensive monitoring for session counts, Kafka, Redis, and DB failures

[SERVICE]
    Flush        30
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# ==================== INPUT: Metrics JSON File ====================
[INPUT]
    Name              tail
    Path              /var/log/aaa-account/metrics.json
    Parser            json
    Tag               aaa.metrics
    Refresh_Interval  30
    Read_from_Head    True
    Skip_Empty_Lines  On

# ==================== INPUT: Application Logs ====================
[INPUT]
    Name              tail
    Path              /var/log/aaa-account/aaa-account.log
    Tag               aaa.application
    Refresh_Interval  5
    Read_from_Head    False
    Multiline         On
    Parser_Firstline  java_multiline

# ==================== INPUT: Health Check Logs ====================
[INPUT]
    Name              tail
    Path              /var/log/aaa-account/health-checks.log
    Tag               aaa.health
    Parser            json
    Refresh_Interval  10
    Read_from_Head    False
    Skip_Empty_Lines  On

# ==================== FILTER: Add Hostname and Environment ====================
[FILTER]
    Name    record_modifier
    Match   aaa.*
    Record  hostname ${HOSTNAME}
    Record  environment ${ENV:production}
    Record  service aaa-accounting

# ==================== FILTER: Extract Session Metrics ====================
[FILTER]
    Name    nest
    Match   aaa.metrics
    Operation lift
    Nested_under gauges
    Add_prefix gauge_

[FILTER]
    Name    nest
    Match   aaa.metrics
    Operation lift
    Nested_under counters
    Add_prefix counter_

# ==================== FILTER: Parse Error Logs ====================
[FILTER]
    Name    grep
    Match   aaa.application
    Regex   log ERROR|WARN|FATAL

# ==================== FILTER: Extract Component Failures ====================
# Extract Kafka failures from application logs
[FILTER]
    Name    grep
    Match   aaa.application
    Regex   log KAFKA.*FAILED|Failed.*Kafka

# Extract Redis failures from application logs
[FILTER]
    Name    grep
    Match   aaa.application
    Regex   log REDIS.*FAILED|Failed.*Redis

# Extract Database failures from application logs
[FILTER]
    Name    grep
    Match   aaa.application
    Regex   log DATABASE.*FAILED|Failed.*database|Error.*fetching

# ==================== FILTER: Alert on High Failure Rates ====================
# Tag metrics with high failure counts for alerting
[FILTER]
    Name    lua
    Match   aaa.metrics
    script  /etc/fluent-bit/scripts/alert_on_failures.lua
    call    check_failure_thresholds

# ==================== OUTPUT: Elasticsearch ====================
# Uncomment and configure to send to Elasticsearch
# [OUTPUT]
#     Name            es
#     Match           aaa.*
#     Host            elasticsearch.example.com
#     Port            9200
#     Index           aaa-accounting
#     Type            _doc
#     Logstash_Format On
#     Logstash_Prefix aaa-accounting
#     Retry_Limit     5

# ==================== OUTPUT: CloudWatch ====================
# Uncomment and configure to send to AWS CloudWatch
# [OUTPUT]
#     Name              cloudwatch_logs
#     Match             aaa.*
#     region            us-east-1
#     log_group_name    /aws/aaa-accounting
#     log_stream_prefix metrics-
#     auto_create_group true

# ==================== OUTPUT: Datadog ====================
# Uncomment and configure to send to Datadog
# [OUTPUT]
#     Name        datadog
#     Match       aaa.*
#     Host        http-intake.logs.datadoghq.com
#     TLS         on
#     compress    gzip
#     apikey      ${DD_API_KEY}
#     dd_service  aaa-accounting
#     dd_source   java
#     dd_tags     env:production,team:platform

# ==================== OUTPUT: Splunk ====================
# Uncomment and configure to send to Splunk
# [OUTPUT]
#     Name            splunk
#     Match           aaa.*
#     Host            splunk.example.com
#     Port            8088
#     Splunk_Token    ${SPLUNK_HEC_TOKEN}
#     TLS             On
#     TLS.Verify      Off

# ==================== OUTPUT: Stdout (for testing) ====================
[OUTPUT]
    Name   stdout
    Match  aaa.metrics
    Format json_lines

# ==================== OUTPUT: File (backup) ====================
[OUTPUT]
    Name   file
    Match  aaa.*
    Path   /var/log/aaa-account/fluent-bit-output
    Format json_lines
